---
// src/components/FeaturedProperties.astro
import { getCollection } from 'astro:content';

const allProjects = await getCollection('projects');
// Ensure we always have items to render
const featuredProjects = allProjects.slice(0, 3);
---

<section id="properties" class="py-24 bg-neutral-900 overflow-hidden">
  <div class="max-w-[1400px] mx-auto px-4 md:px-8 h-full flex flex-col">
    
    {/* SECTION HEADER */}
    <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-6 z-10 relative px-2">
      <div>
        <span class="text-[10px] md:text-xs font-bold tracking-[0.4em] text-gold-400 uppercase mb-3 block">
          Exclusive Portfolio
        </span>
        <h2 class="text-3xl md:text-5xl font-light tracking-tighter text-white leading-none">
          Featured <span class="font-serif italic text-neutral-500">Works</span>
        </h2>
      </div>
      
      <a href="/projects" class="group flex items-center gap-3 text-[10px] md:text-xs font-bold tracking-[0.2em] uppercase text-neutral-400 hover:text-white transition-colors pb-2 border-b border-transparent hover:border-gold-500">
        View Collection
        <span class="group-hover:translate-x-2 transition-transform duration-500 ease-out">â†’</span>
      </a>
    </div>

    {/* PROPERTIES GRID */}
    <div class="flex flex-col md:flex-row gap-2 md:gap-4 w-full h-auto">
      {featuredProjects.map((project, index) => (
        <a 
          href={`/projects/${project.slug}`} 
          class="
            group relative 
            project-card /* Hook for JS */
            
            /* --- SAFETY START STATE --- */
            /* Start visible by default. JS will hide it for animation if active. */
            opacity-100 translate-y-0
            
            /* --- LAYOUT --- */
            /* Mobile: Fixed height stack */
            flex-none w-full h-[350px] 
            
            /* Desktop: Accordion Logic */
            md:flex-[1] md:h-[600px] md:w-auto
            md:hover:flex-[3] 
            
            /* Transitions & Base Styles */
            transition-all duration-1000 ease-[cubic-bezier(0.25,1,0.5,1)]
            overflow-hidden
            rounded-sm
          "
        >
          
          {/* 1. BACKGROUND IMAGE */}
          <div class="absolute inset-0 w-full h-full">
            <div class="absolute inset-0 bg-black/30 md:group-hover:bg-transparent z-10 transition-colors duration-700"></div>
            <img 
              src={project.data.coverImage} 
              alt={project.data.title}
              class="w-full h-full object-cover grayscale-[20%] md:group-hover:grayscale-0 md:group-hover:scale-105 transition-all duration-1000 ease-out"
            />
          </div>

          {/* 2. OVERLAY GRADIENT */}
          <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-black/40 to-transparent opacity-90 z-20"></div>

          {/* 3. CONTENT CONTAINER */}
          <div class="absolute bottom-0 left-0 w-full p-6 md:p-8 z-30 flex flex-col justify-end h-full">
            
            {/* Status Badge */}
            <div class="mb-auto opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity duration-500 delay-200">
                <span class="bg-gold-500/90 text-black px-2 py-1 text-[9px] uppercase tracking-widest font-bold backdrop-blur-sm">
                    {project.data.status}
                </span>
            </div>

            {/* Title Block */}
            <div class="transform translate-y-0 md:translate-y-2 md:group-hover:translate-y-0 transition-transform duration-500">
                <span class="text-gold-400 text-[10px] font-bold tracking-[0.2em] uppercase mb-2 block opacity-90">
                    {project.data.location}
                </span>

                <h3 class="text-2xl md:text-2xl lg:text-4xl font-light text-white leading-tight mb-2 break-words">
                    {project.data.title}
                </h3>
            </div>

            {/* Hidden Details */}
            <div class="
                grid grid-rows-[1fr] opacity-100
                md:grid-rows-[0fr] md:opacity-0 
                md:group-hover:grid-rows-[1fr] md:group-hover:opacity-100
                transition-all duration-700 ease-out
            ">
                <div class="overflow-hidden">
                    <p class="text-neutral-300 font-light text-xs md:text-sm border-l border-gold-500 pl-3 mb-4 mt-2 max-w-md leading-relaxed line-clamp-2 md:line-clamp-none">
                        A modern architectural statement featuring {project.data.details?.[0]?.value || 'luxury amenities'}.
                    </p>
                    
                    <span class="inline-flex items-center gap-2 text-white text-[10px] font-bold uppercase tracking-widest group/btn hover:text-gold-400 transition-colors">
                        View Project
                        <div class="w-4 h-[1px] bg-white group-hover/btn:w-8 group-hover/btn:bg-gold-400 transition-all duration-300"></div>
                    </span>
                </div>
            </div>

          </div>
        </a>
      ))}
    </div>

  </div>
</section>

{/* REPLAYABLE SCROLL ANIMATION SCRIPT */}
<script is:inline data-astro-rerun>
  // Global function allows it to run across page navigations
  window.initProjectAnimations = () => {
    
    // 1. Only run on mobile (width < 768px)
    if (window.innerWidth >= 768) return;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        const card = entry.target;
        
        if (entry.isIntersecting) {
          // SLIDE UP: Remove hidden state
          card.classList.remove('opacity-0', 'translate-y-12');
          card.classList.add('opacity-100', 'translate-y-0');
        } else {
          // RESET: Hide it again when user scrolls away
          card.classList.remove('opacity-100', 'translate-y-0');
          card.classList.add('opacity-0', 'translate-y-12');
        }
      });
    }, { 
      threshold: 0.15, // Trigger when 15% is visible
      rootMargin: "0px 0px -50px 0px" 
    });

    const cards = document.querySelectorAll('.project-card');
    
    cards.forEach((card, index) => {
      // PREPARE: Hide immediately via JS so they can slide in
      card.classList.remove('opacity-100', 'translate-y-0');
      card.classList.add('opacity-0', 'translate-y-12');
      
      // Stagger delay for a premium feel
      card.style.transitionDelay = `${index * 150}ms`;
      
      observer.observe(card);
    });
  };

  // Run on initial load
  window.initProjectAnimations();

  // Run on Astro View Transition (Client Router) navigation
  document.addEventListener('astro:page-load', window.initProjectAnimations);
</script>