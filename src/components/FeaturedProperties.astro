---
// src/components/FeaturedProperties.astro
import { getCollection } from 'astro:content';

const allProjects = await getCollection('projects');
const featuredProjects = allProjects.slice(0, 3);
---

<section id="properties" class="py-24 bg-neutral-900 overflow-hidden">
  <div class="max-w-[1400px] mx-auto h-full flex flex-col">
    
    {/* HEADER */}
    <div class="px-6 md:px-12 flex flex-row flex-wrap justify-between items-end mb-8 md:mb-12 gap-6 z-10 relative">
      <div>
        <span class="text-[10px] md:text-xs font-bold tracking-[0.4em] text-gold-400 uppercase mb-3 block">
          Exclusive Portfolio
        </span>
        <h2 class="text-3xl md:text-5xl font-light tracking-tighter text-white leading-none">
          Featured <span class="font-serif italic text-neutral-500">Works</span>
        </h2>
      </div>
      
      <a href="/projects" class="flex group items-center gap-3 text-xs font-bold tracking-[0.2em] uppercase text-neutral-400 hover:text-white transition-colors pb-2 border-b border-transparent hover:border-gold-500">
        View Collection
        <span class="group-hover:translate-x-2 transition-transform duration-500 ease-out">â†’</span>
      </a>
    </div>

    {/* SCROLL CONTAINER */}
    <div 
        id="projects-carousel"
        class="
            flex 
            flex-row gap-4 overflow-x-auto snap-x snap-mandatory 
            px-6 pb-12 
            md:overflow-visible md:gap-4 md:px-12 md:pb-0
            w-full h-auto
            no-scrollbar
    ">
      
      {featuredProjects.map((project, index) => (
        <a 
          href={`/projects/${project.slug}`} 
          data-index={index}
          class="
            group relative 
            project-card 
            snap-center shrink-0 
            w-[85vw] h-[65vh] 
            rounded-[32px] 
            md:w-auto md:h-[600px] 
            md:flex-[1] md:hover:flex-[3] 
            md:rounded-sm 
            transition-all duration-700 ease-[cubic-bezier(0.25,1,0.5,1)]
            overflow-hidden
            block
            border border-white/5 hover:border-gold-500/30 /* Subtle border for theme consistency */
          "
        >
          {/* IMAGE */}
          <div class="absolute inset-0 w-full h-full">
            {/* Darker gradient for better text contrast */}
            <div class="absolute inset-0 bg-gradient-to-t from-neutral-950 via-neutral-950/40 to-transparent z-10"></div>
            <img 
              src={project.data.coverImage} 
              alt={project.data.title}
              class="w-full h-full object-cover grayscale-[10%] md:group-hover:grayscale-0 md:group-hover:scale-105 transition-all duration-1000 ease-out"
            />
          </div>

          {/* CONTENT */}
          <div class="absolute inset-0 p-6 md:p-8 z-20 flex flex-col justify-end">
            <div class="absolute top-6 left-6">
                 <span class="bg-black/40 backdrop-blur-md border border-white/10 text-white px-3 py-1.5 text-[10px] font-bold uppercase tracking-wider rounded-full">
                    {project.data.status}
                </span>
            </div>

            <div class="mb-6 transform transition-transform duration-500 md:group-hover:-translate-y-2">
                <span class="text-gold-400 text-[10px] font-bold tracking-[0.2em] uppercase mb-2 block">
                    {project.data.location}
                </span>
                <h3 class="text-3xl md:text-2xl lg:text-4xl font-manrope font-light text-white leading-tight mb-3 break-words">
                    {project.data.title}
                </h3>
                <p class="text-neutral-400 text-sm line-clamp-2 opacity-0 md:group-hover:opacity-100 transition-opacity duration-500 delay-100 hidden md:block">
                      A masterpiece of modern architecture featuring {project.data.details?.[0]?.value}.
                </p>
            </div>

            {/* BUTTON - UPDATED TO GOLD THEME */}
            <div class="mt-2">
                <button class="
                    w-full 
                    bg-[#b88a44] text-white 
                    font-bold text-xs py-4 rounded-xl 
                    uppercase tracking-[0.2em]
                    transition-all duration-300
                    hover:bg-[#d4a055] hover:shadow-[0_0_20px_rgba(184,138,68,0.3)]
                    border border-transparent hover:border-gold-300/50
                ">
                    Explore Project
                </button>
            </div>
          </div>
        </a>
      ))}
      
      <div class="shrink-0 w-2 md:hidden"></div>
    </div>
    
    {/* PAGINATION DOTS (MOBILE) */}
    <div class="flex justify-center gap-2 mt-4 md:hidden">
        {featuredProjects.map((_, i) => (
            <div 
                id={`dot-${i}`} 
                class={`pagination-dot w-2 h-2 rounded-full transition-colors duration-300 ${i === 0 ? 'bg-[#b88a44] scale-125' : 'bg-neutral-800'}`}
            ></div>
        ))}
    </div>

  </div>
</section>

<style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>

<script is:inline data-astro-rerun>
  (() => {
      const carousel = document.getElementById('projects-carousel');
      if (!carousel) return;

      if (window.innerWidth >= 768) return;

      const cards = carousel.querySelectorAll('.project-card');
      const dots = document.querySelectorAll('.pagination-dot');

      const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
              if (entry.isIntersecting) {
                  const index = entry.target.getAttribute('data-index');
                  dots.forEach(dot => {
                      dot.classList.remove('bg-[#b88a44]', 'scale-125');
                      dot.classList.add('bg-neutral-800');
                  });

                  const activeDot = document.getElementById(`dot-${index}`);
                  if (activeDot) {
                      activeDot.classList.remove('bg-neutral-800');
                      activeDot.classList.add('bg-[#b88a44]', 'scale-125');
                  }
              }
          });
      }, {
          root: carousel,
          threshold: 0.6
      });

      cards.forEach(card => observer.observe(card));
  })();
</script>