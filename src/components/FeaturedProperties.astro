---
// src/components/FeaturedProperties.astro
import { getCollection } from 'astro:content';

const allProjects = await getCollection('projects');
const featuredProjects = allProjects.slice(0, 3);
---

<section id="properties" class="py-24 bg-neutral-900 overflow-hidden">
  <div class="max-w-[1400px] mx-auto h-full flex flex-col">
    
    {/* HEADER */}
    <div class="px-6 md:px-12 flex flex-col md:flex-row justify-between items-end mb-8 md:mb-12 gap-6 z-10 relative">
      <div>
        <span class="text-[10px] md:text-xs font-bold tracking-[0.4em] text-gold-400 uppercase mb-3 block">
          Exclusive Portfolio
        </span>
        <h2 class="text-3xl md:text-5xl font-light tracking-tighter text-white leading-none">
          Featured <span class="font-serif italic text-neutral-500">Works</span>
        </h2>
      </div>
      
      <a href="/projects" class="hidden md:flex group items-center gap-3 text-xs font-bold tracking-[0.2em] uppercase text-neutral-400 hover:text-white transition-colors pb-2 border-b border-transparent hover:border-gold-500">
        View Collection
        <span class="group-hover:translate-x-2 transition-transform duration-500 ease-out">â†’</span>
      </a>
    </div>

    {/* SCROLL CONTAINER */}
    <div 
        id="projects-carousel"
        class="
            flex 
            flex-row gap-4 overflow-x-auto snap-x snap-mandatory 
            px-6 pb-12 
            md:overflow-visible md:gap-4 md:px-12 md:pb-0
            w-full h-auto
            no-scrollbar
    ">
      
      {featuredProjects.map((project, index) => (
        <a 
          href={`/projects/${project.slug}`} 
          data-index={index} /* 1. Added data-index to track position */
          class="
            group relative 
            project-card 
            snap-center shrink-0 
            w-[85vw] h-[65vh] 
            rounded-[32px] 
            md:w-auto md:h-[600px] 
            md:flex-[1] md:hover:flex-[3] 
            md:rounded-sm 
            transition-all duration-700 ease-[cubic-bezier(0.25,1,0.5,1)]
            overflow-hidden
            block
          "
        >
          {/* IMAGE */}
          <div class="absolute inset-0 w-full h-full">
            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent z-10"></div>
            <img 
              src={project.data.coverImage} 
              alt={project.data.title}
              class="w-full h-full object-cover grayscale-[10%] md:group-hover:grayscale-0 md:group-hover:scale-105 transition-all duration-1000 ease-out"
            />
          </div>

          {/* CONTENT */}
          <div class="absolute inset-0 p-6 md:p-8 z-20 flex flex-col justify-end">
            <div class="absolute top-6 left-6">
                 <span class="bg-white/20 backdrop-blur-md text-white px-3 py-1.5 text-[10px] font-bold uppercase tracking-wider rounded-md">
                    {project.data.status}
                </span>
            </div>

            <div class="mb-4">
                <span class="text-neutral-400 text-[10px] font-bold tracking-[0.2em] uppercase mb-2 block">
                    {project.data.location}
                </span>
                <h3 class="text-3xl md:text-2xl lg:text-4xl font-manrope font-medium text-white leading-tight mb-2 break-words">
                    {project.data.title}
                </h3>
                <p class="text-neutral-300 text-sm line-clamp-2 md:hidden md:group-hover:block transition-all">
                     A masterpiece of modern architecture featuring {project.data.details?.[0]?.value}.
                </p>
            </div>

            <div class="mt-2">
                <button class="w-full bg-white text-black font-bold text-sm py-4 rounded-xl hover:bg-neutral-200 transition-colors uppercase tracking-widest">
                    Explore
                </button>
            </div>
          </div>
        </a>
      ))}
      
      <div class="shrink-0 w-2 md:hidden"></div>
    </div>
    
    {/* 2. PAGINATION DOTS (MOBILE) */}
    <div class="flex justify-center gap-2 mt-4 md:hidden">
        {featuredProjects.map((_, i) => (
            <div 
                id={`dot-${i}`} 
                class={`pagination-dot w-2 h-2 rounded-full transition-colors duration-300 ${i === 0 ? 'bg-white scale-125' : 'bg-neutral-700'}`}
            ></div>
        ))}
    </div>

  </div>
</section>

<style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>

{/* 3. SCRIPT TO SYNC DOTS WITH SCROLL */}
<script is:inline data-astro-rerun>
  // This wrapper ensures it runs on initial load AND after View Transitions
  (() => {
      const carousel = document.getElementById('projects-carousel');
      if (!carousel) return;

      // Only run on mobile where carousel exists
      if (window.innerWidth >= 768) return;

      const cards = carousel.querySelectorAll('.project-card');
      const dots = document.querySelectorAll('.pagination-dot');

      const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
              if (entry.isIntersecting) {
                  // Get the index of the currently visible card
                  const index = entry.target.getAttribute('data-index');
                  
                  // Reset all dots
                  dots.forEach(dot => {
                      dot.classList.remove('bg-white', 'scale-125');
                      dot.classList.add('bg-neutral-700');
                  });

                  // Highlight active dot
                  const activeDot = document.getElementById(`dot-${index}`);
                  if (activeDot) {
                      activeDot.classList.remove('bg-neutral-700');
                      activeDot.classList.add('bg-white', 'scale-125');
                  }
              }
          });
      }, {
          root: carousel,
          threshold: 0.6 // Trigger when 60% of the card is visible
      });

      cards.forEach(card => observer.observe(card));
  })();
</script>